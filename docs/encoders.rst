
.. currentmodule:: acid.encoders


Encoders
########



.. _record-encoder:

Encoder Interface
+++++++++++++++++

.. autoclass:: RecordEncoder


Compressor Interface
++++++++++++++++++++

.. autoclass:: Compressor


Predefined Record Encoders
++++++++++++++++++++++++++

.. attribute:: KEY

    This predefined :py:class:`RecordEncoder` uses :py:func:`acid.keylib.packs`
    and :py:func:`acid.keylib.unpacks` to serialize tuples. It is used
    internally to represent keys, counters, and :py:class:`Store <acid.Store>`
    metadata.

.. attribute:: JSON

    This predefined :py:class:`RecordEncoder` uses :py:func:`json.dumps` and
    :py:func:`json.loads` to serialize compatible objects. It is the default
    encoder if no specific `encoder=` argument is given to the
    :py:class:`Collection <acid.Collection>` constructor.


Predefined Compressors
++++++++++++++++++++++

.. attribute:: PLAIN

    This predefined :py:class:`Compressor` returns its input unchanged. It is
    used as the default :py:class:`Collection(..., packer=) <acid.Collection>`
    argument when no explicit compressor is provided.

.. attribute:: ZLIB

    This predefined :py:class:`Compressor` uses :py:func:`zlib.compress` and
    :py:func:`zlib.decompress` to provide value compression. It may be passed
    as the `packer=` argument to :py:meth:`Collection.put
    <acid.Collection.put>`, or specified as the default using the `packer=`
    argument to the :py:class:`Collection <acid.Collection>` constructor.


make_pickle_encoder
+++++++++++++++++++

.. autofunction:: make_pickle_encoder


make_json_encoder
+++++++++++++++++

.. autofunction:: make_json_encoder


make_msgpack_encoder
++++++++++++++++++++

.. autofunction:: make_msgpack_encoder


make_thrift_encoder
+++++++++++++++++++

.. autofunction:: make_thrift_encoder


Example
-------

Create a ``myproject.thrift`` file:

::

    struct Person {
        1: string username,
        2: string city,
        3: i32 age
    }

Now define a collection:

::

    # 'myproject' package is generated by 'thrift --genpy myproject.thrift'
    from myproject.ttypes import Person
    from acid.support import make_thrift_encoder

    coll = acid.Collection(store, 'people',
        encoder=make_thrift_encoder(Person))
    coll.add_index('username', lambda person: person.username)
    coll.add_index('age_city', lambda person: (person.age, person.city))

    user = Person(username=u'David', age=42, city='Trantor')
    coll.put(user)

    assert coll.indices['username'].get(u'David') == user

    # Minimal overhead:
    packed = coll.encoder.pack(Person(username='dave'))
    assert packed == '\x18\x04dave\x00'



Key Functions
+++++++++++++

These functions are based on `SQLite 4's key encoding
<http://sqlite.org/src4/doc/trunk/www/key_encoding.wiki>`_, except that:

* Support for ``uuid.UUID`` is added.
* Floats are removed.
* Varints are used for integers.

.. currentmodule:: acid.keylib

.. function:: pack (prefix, tups)

    Alias for :py:func:`packs`

.. autofunction:: packs

.. function:: unpack

    Alias for :py:func:`unpacks` with `first=True`.

.. autofunction:: unpacks
.. autofunction:: invert
